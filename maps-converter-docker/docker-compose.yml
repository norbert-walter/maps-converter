####################################################################
# OBP Maps Converter
#
# Open Boat Projects, Norbert Walter (C) 2025
#
# Usage in bash:
#
# For production: docker compose --profile prod up -d --build
# For development: docker compose --profile dev up -d --build
#
####################################################################

version: "3.9"

services:
  # Production service
  maps:
    build:
      context: .
      dockerfile: Dockerfile
    image: maps-converter:latest
    container_name: maps-converter
    ports:
      - "${PORT}:8080"
    environment:
      TZ: ${TZ}
      FLASK_ENV: ${FLASK_ENV}
      TILE_CACHE_DIR: /app/tile_cache
      LOG_DIR: /app/logs
      WORKERS: ${WORKERS}
      THREADS: ${THREADS}
      TIMEOUT: ${TIMEOUT}
    volumes:
      - ${TILE_CACHE_DIR}:/app/tile_cache
      - ${LOG_DIR}:/app/logs
    restart: unless-stopped
    profiles: ["prod"]
    # Logging rotation (prevents growing stdout logs)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Development service
  maps-dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: maps-converter:dev
    container_name: maps-converter-dev
    ports:
      - "${PORT}:8080"
    environment:
      TZ: ${TZ}
      FLASK_ENV: development
    volumes:
      - ${TILE_CACHE_DIR}:/app/tile_cache
      - ${LOG_DIR}:/app/logs
      - ./Maps_Converter_V1_20.py:/app/Maps_Converter_V1_20.py:rw
      - ./static:/app/static:rw
    restart: unless-stopped
    # Overrides the CMD from the Dockerfile for the local dev server
    command: ["python", "Maps_Converter_V1_20.py"]
    profiles: ["dev"]
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

